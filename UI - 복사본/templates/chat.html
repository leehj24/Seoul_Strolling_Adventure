<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ ì¶”ì²œ ì±—ë´‡ ì±„ì±„</title>

  <style>
    /* â”€â”€â”€ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ â”€â”€â”€ */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Apple SD Gothic Neo',sans-serif;
      background:#f5f5f5; color:#333;
      display:flex; flex-direction:column; height:100vh;
    }
    header {
      padding:1rem 2rem; background:#fff; border-bottom:1px solid #eee;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { font-size:1.2rem; }

    .chat-main { flex:1; display:flex; flex-direction:column; }
    #chat-window { flex:1; padding:1rem; overflow-y:auto; }

    /* â”€â”€â”€ ì±„íŒ… ë²„ë¸” â”€â”€â”€ */
    .message { display:flex; margin-bottom:1rem; }
    .message.bot  { justify-content:flex-start; }
    .message.user { justify-content:flex-end;  }
    .message .icon { width:32px; height:32px; flex-shrink:0; margin-right:.5rem; }
    .message.user .icon { margin-left:.5rem; margin-right:0; }
    .message .icon svg { width:24px; height:24px; fill:#222; }
    .message .text {
      max-width:70%; padding:.75rem 1rem;
      background:#f0f0f0; border-radius:12px 12px 12px 0;
      white-space:pre-wrap;
    }
    .message.user .text {
      background:#222; color:#fff; border-radius:12px 12px 0 12px;
    }

    /* â”€â”€â”€ ì…ë ¥ì°½ â”€â”€â”€ */
    .input-area {
      display:flex; align-items:center;
      padding:.5rem 1rem; background:#fff; border-top:1px solid #ddd;
    }
    .input-area input {
      flex:1; padding:.75rem 1rem;
      border:1px solid #ccc; border-radius:20px;
    }
    .input-area button {
      width:48px; height:48px; margin-left:.5rem;
      border:none; border-radius:50%; background:#222;
      display:flex; justify-content:center; align-items:center;
      cursor:pointer;
    }
    .input-area button svg { fill:#fff; }

    /* â”€â”€â”€ í…Œë§ˆÂ·ì„ í˜¸ë„ ì¹´ë“œ â”€â”€â”€ */
    .theme-container {
      display:grid; grid-template-columns:repeat(4,1fr); gap:.75rem;
      padding:1rem; background:#fff;
    }
    .pref-container {
      display:flex; flex-direction:column; gap:.5rem;
      padding:1rem; background:#fff;
    }
    .theme-card, .pref-card {
      background:#fff; border:1px solid #ccc; border-radius:8px;
      padding:1rem; text-align:center; cursor:pointer; transition:.2s;
    }
    .theme-card.selected, .pref-card.selected {
      background:#222; border-color:#222; color:#fff;
    }
    .theme-card .icon, .pref-card .icon {
      font-size:24px; margin-bottom:.5rem;
    }

    .btn-complete {
      margin:0 1rem 1rem; padding:.75rem;
      border:none; border-radius:4px; width:calc(100% - 2rem);
      font-size:1rem; background:#222; color:#fff;
      text-align:center; opacity:.5; cursor:pointer; transition:.2s;
    }
    .btn-complete.enabled { opacity:1; }
    .restart {
      margin:1rem; padding:.75rem; border:none; border-radius:4px;
      background:#222; color:#fff; width:calc(100% - 2rem);
      font-size:1rem; cursor:pointer;
    }

    /* â”€â”€â”€ ì¶”ì²œ ì¹´ë“œ ë°•ìŠ¤ â”€â”€â”€ */
    .recommend-box {
      border:2px solid #222; border-radius:10px;
      margin:1rem 0; background:#fff; padding:1rem;
    }
    .recommend-box h3 { margin-bottom:1rem; font-size:1.1rem; }

    .card-container {
      display:grid; grid-template-columns:repeat(2,1fr); gap:1rem;   /* 2ì—´ */
    }
    .route-card {
      background:#f7f7f7; border:1px solid #ddd; border-radius:8px;
      padding:1rem 1.25rem; display:flex; align-items:center; gap:.75rem;
      cursor:pointer; transition:.2s;
    }
    .route-card:hover { box-shadow:0 3px 10px rgba(0,0,0,.1); }
    .badge {
      min-width:32px; height:32px; border-radius:50%;
      background:#222; color:#fff; text-align:center;
      line-height:32px; font-size:.9rem;
    }
    .stage-name { flex:1; font-size:.95rem; }

    /* â”€â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€â”€ */
    #loader-overlay{
      position:fixed; inset:0; z-index:1000;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
    }
    .spinner{
      width:54px; height:54px;
      border:6px solid #f3f3f3; border-top:6px solid #111;
      border-radius:50%; animation:spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }
  </style>
</head>

<body>
  <!-- â”€â”€â”€ í—¤ë” â”€â”€â”€ -->
  <header>
    <h1>ì—¬í–‰ ì¶”ì²œ ì±—ë´‡ ì±„ì±„</h1>
    <button onclick="location.href='{{ url_for('index') }}'"
            style="border:none;background:none;font-size:1.3rem">ğŸ </button>
  </header>

  <div class="chat-main">
    <!-- â”€â”€â”€ ì±„íŒ… ì˜ì—­ â”€â”€â”€ -->
    <div id="chat-window">
      {% for msg in session.get('messages', []) %}
        <div class="message {{ msg.sender }}">
          <div class="icon">
            <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
          </div>
          <div class="text">{{ msg.text }}</div>
        </div>
      {% endfor %}

      {% if session.get('state') == 'ì™„ë£Œ' and session.get('routes') %}
        <div class="recommend-box">
          <h3>ëŒ€ì¤‘êµí†µ ì¶”ì²œê²½ë¡œ</h3>
          <div class="card-container">
            {% for rt in session.get('routes')[:10] %}
              <a href="{{ url_for('route_detail', idx=loop.index0) }}" class="route-card">
                <span class="badge">{{ loop.index }}</span>
                <span class="stage-name">{{ rt['ë‹¨ê³„'] }}</span>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- â”€â”€â”€ ì…ë ¥ì°½ / ë‹¨ê³„ë³„ UI â”€â”€â”€ -->
    {% if session.get('state') in ['ì§€ì—­','ì™„ë£Œ'] %}
      <form class="input-area" method="post" action="{{ url_for('chat') }}">
        <input type="text" name="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required>
        <button type="submit">
          <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </form>
    {% endif %}

    {% if session.get('state') == 'í…Œë§ˆ' %}
      <div class="theme-container">
        {% for t,icon in [
            ('ìŒì‹','ğŸ´'),('ê´€ê´‘','ğŸ«'),('ë ˆí¬ì¸ ','ğŸ„'),('ì‡¼í•‘','ğŸ›ï¸'),
            ('ìì—°','ğŸŒ³'),('ë¬¸í™”','ğŸ­'),('ì—­ì‚¬','ğŸ“œ'),('íë§','â¤ï¸')
        ] %}
          <div class="theme-card" data-value="{{ t }}">
            <div class="icon">{{ icon }}</div>
            <div class="label">{{ t }}</div>
          </div>
        {% endfor %}
      </div>
      <button id="theme-complete" class="btn-complete">ì„ íƒ ì™„ë£Œ (0/3)</button>
      <form id="theme-form" method="post" action="{{ url_for('chat') }}">
        <input type="hidden" name="themes" id="themes-input">
      </form>
    {% endif %}

    {% if session.get('state') == 'ì„ í˜¸ë„' %}
      <div class="pref-container">
        {% for p,icon in [('ì¸ê¸°ë„','ğŸ‘'),('ëŒ€ì¤‘êµí†µ','ğŸš‹'),('ë³´í–‰','ğŸš¶')] %}
          <div class="pref-card" data-value="{{ p }}">
            <div class="icon">{{ icon }}</div>
            <div class="label">{{ p }}</div>
          </div>
        {% endfor %}
      </div>
      <button id="pref-complete" class="btn-complete">ì„ íƒ ì™„ë£Œ</button>
      <form id="pref-form" method="post" action="{{ url_for('chat') }}">
        <input type="hidden" name="preferences" id="pref-input">
      </form>
    {% endif %}

    {% if session.get('state') == 'ì™„ë£Œ' %}
      <button class="restart" onclick="location.href='{{ url_for('start') }}'">
        ìƒˆ ì±„íŒ…í•˜ê¸°
      </button>
    {% endif %}
  </div>

  <!-- â”€â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€â”€ -->
  <div id="loader-overlay"><div class="spinner"></div></div>

  <!-- â”€â”€â”€ JS â”€â”€â”€ -->
  <script>
    const state   = "{{ session.get('state') }}";
    const chatWin = document.getElementById('chat-window');
    if (chatWin) chatWin.scrollTop = chatWin.scrollHeight;

    /* ===== ë¡œë”© ìŠ¤í”¼ë„ˆ ===== */
    const loader = document.getElementById('loader-overlay');
    function showLoader(){ loader.style.display='flex'; }
    function hideLoader(){ loader.style.display='none'; }

    /* ëª¨ë“  form submit ì‹œ ìŠ¤í”¼ë„ˆ */
    document.querySelectorAll('form').forEach(f=>{
      f.addEventListener('submit', showLoader);
    });

    /* ì¶”ì²œ ì¹´ë“œ í´ë¦­ ì‹œ ìŠ¤í”¼ë„ˆ */
    document.querySelectorAll('.route-card').forEach(a=>{
      a.addEventListener('click', showLoader);
    });

    /* ===== í…Œë§ˆ ì„ íƒ ë¡œì§ ===== */
    if (state === 'í…Œë§ˆ') {
      const cards = document.querySelectorAll('.theme-card');
      const btn   = document.getElementById('theme-complete');
      const input = document.getElementById('themes-input');
      let   sel   = [];

      btn.disabled = true;

      cards.forEach(card => {
        card.addEventListener('click', () => {
          const v = card.dataset.value;
          if (card.classList.contains('selected')) {
            card.classList.remove('selected');
            sel = sel.filter(x => x !== v);
          } else if (sel.length < 3) {
            card.classList.add('selected');
            sel.push(v);
          }
          btn.textContent = `ì„ íƒ ì™„ë£Œ (${sel.length}/3)`;
          btn.disabled    = sel.length < 1;
          btn.classList.toggle('enabled', sel.length > 0);
        });
      });

      btn.addEventListener('click', () => {
        input.value = sel.join(',');
        showLoader();                    // ì„ íƒ ì™„ë£Œ ì‹œ ìŠ¤í”¼ë„ˆ
        document.getElementById('theme-form').submit();
      });
    }

    /* ===== ì„ í˜¸ë„ ì„ íƒ ë¡œì§ ===== */
    if (state === 'ì„ í˜¸ë„') {
      const cards = document.querySelectorAll('.pref-card');
      const btn   = document.getElementById('pref-complete');
      const input = document.getElementById('pref-input');
      let   sel   = [];

      btn.disabled = true;

      cards.forEach(card => {
        card.addEventListener('click', () => {
          const v = card.dataset.value;
          if (!card.classList.contains('selected')) {
            card.classList.add('selected');
            sel.push(v);
          }
          btn.disabled = sel.length !== cards.length;
          btn.classList.toggle('enabled', sel.length === cards.length);
        });
      });

      btn.addEventListener('click', () => {
        input.value = sel.join(',');
        showLoader();                    // ì„ íƒ ì™„ë£Œ ì‹œ ìŠ¤í”¼ë„ˆ
        document.getElementById('pref-form').submit();
      });
    }
  </script>
</body>
</html>
